# 04 - 第二步：技术面分析

技术面负责从 K 线数据里算出「均线、MACD、KDJ」以及「入场/离场参考」，并把结果整理成一段「数值摘要」给后面的 LLM 用。本篇用通俗方式说明：这些指标是什么、怎么算、代码在哪。

---

## 一、技术面在整体里扮演什么角色

- **输入**：某只股票的 K 线（开高低收、成交量），来自 yfinance 的 `stock.history(period=..., interval=..., prepost=...)`。  
- **输出**：一个字典，包含均线趋势、MACD 摘要、KDJ 摘要、以及「入场参考 / 离场参考」的简短文字。  
- **用途**：`full_analysis` 会把这些内容拼进 Prompt，让 LLM 据此描述「趋势结构、MACD 状态、KDJ 状态」，并给出加仓/减仓价建议。

也就是说：**技术面不直接下结论，只负责「算指标 + 写一两句参考」，结论由 LLM 综合技术+消息+财报+期权一起出。**

---

## 二、支持哪些 K 线周期

- **日 K（interval=1d）**：默认拉约 6 个月，用于波段；要算 MA60 至少需要 60 根 K 线。  
- **分 K（1m/5m/15m/30m/60m）**：默认拉约 5 天（yfinance 对 1m 限制更严），用于超短线；分 K 下 MA60 可能不足 60 根，会放宽到至少 30 根再算。

是否包含盘前盘后由参数 `prepost` 控制；日 K 且勾选盘前盘后时，**当前价与涨跌幅**在财报模块里会优先用盘前/盘后价（见第六篇财报与估值），技术面这里只是 K 线是否带盘前盘后。

---

## 三、算了哪些指标（通俗解释）

### 1. 均线（MA）

- 用收盘价算：MA5、MA10、MA20、MA60（当前 K 线对应的滚动均值）。  
- 再判断：当前价是否在 MA5/MA20/MA60 之上；以及是否「多头排列」：价格 > MA5 > MA10 > MA20 > MA60。  
- 这些布尔和数值都会放进 `trend_ma`，供 LLM 写「趋势结构」和「是否多头排列」等描述。

### 2. MACD

- 标准参数：快线 12、慢线 26、信号线 9。  
- 算出：MACD 线、Signal 线、柱状图（histogram），以及当前是否在零轴上方、是否刚发生金叉（MACD 上穿 Signal）。  
- 结果放在 `macd_summary`，LLM 用来写「MACD 状态」一句话。

### 3. KDJ

- 用最高、最低、收盘算 RSV，再得到 K、D、J。  
- 当前 K 是否 >80（超买）、是否 <20（超卖）会放进 `kdj_summary`，LLM 用来写「KDJ 状态」。

### 4. 入场/离场参考（tech_levels）

- **离场**：跌破 MA20 约多少考虑减仓、跌破 MA60 考虑离场；再结合 ATR（约 1.5 倍 ATR 止损）给一个参考价位。  
- **入场**：突破/站稳 MA20 约多少可考虑入场；若近期高点高于当前价，会给出「突破某价位为强势信号」。  
- 写成简短中文句子，放在 `entry_note` 和 `exit_note`，既在报告卡片里展示，也拼进 Prompt，让 LLM 据此给「加仓价格、减仓价格」。

实现里还用了 ATR（14 周期）算波动，用于止损参考；具体公式和规则在 `agents/technical._compute_entry_exit_levels`。

---

## 四、数据不足时怎么办

若历史 K 线根数不够（日 K 不足 60 根、分 K 不足 30 根），或没有 Close/High/Low 等列，`get_technical_summary` 会返回 `ok: False`，并带 `reason`（如「历史数据不足」「行情结构异常」）。  
`full_analysis` 里会把这种情况写成「技术面：无数据」之类文字拼进 Prompt，LLM 仍可结合消息面、财报、期权给出综合结论，只是技术部分没有数值。

---

## 五、对应代码位置

- **入口**：`agents/technical.get_technical_summary(ticker, period=None, interval="1d", prepost=False)`  
- **MACD/KDJ/ATR 计算**：同文件里的 `_macd`、`_kdj`、`_atr`  
- **入场/离场文案**：`_compute_entry_exit_levels(...)`  
- **调用方**：`agents/full_analysis.run_full_analysis` 里先调 `get_technical_summary`，再把返回的 `trend_ma`、`macd_summary`、`kdj_summary`、`tech_levels` 等拼进 `_build_prompt` 的「技术面」段落。

---

## 六、下一篇

下一步：[05 - 第三步：消息面与新闻摘要](05-第三步-消息面与新闻摘要.md) —— 新闻从哪里拉、怎样用 LLM 做 1～2 句摘要再喂给综合评分。
