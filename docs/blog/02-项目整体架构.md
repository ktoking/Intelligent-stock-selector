# 02 - 项目整体架构

这一篇介绍项目的目录结构、技术栈，以及「从请求 Report 到生成 HTML」的整体数据流，方便后面每一篇对号入座。

---

## 一、目录结构（精简说明）

```
stock-agent/
├── server.py              # HTTP 服务入口，FastAPI，/report、/analyze、/memory 等
├── llm.py                  # LLM 调用封装（Ollama/DeepSeek/OpenAI）
├── main.py                 # 可选命令行入口
├── requirements.txt        # 依赖
├── config/
│   ├── llm_config.py       # 温度、max_tokens、Prompt 风格等可调参数
│   └── tickers.py          # 选股池、多市场、股票代码规范化（如 A 股补 .SS/.SZ）
├── agents/                 # 各类「分析能力」的实现
│   ├── technical.py        # 技术面：均线、MACD、KDJ、入场/离场参考
│   ├── news.py             # 消息面：新闻拉取、新闻摘要 LLM
│   ├── fundamental.py      # 财报与估值：财报数据、财报解读 LLM、PE/市值等
│   ├── options.py         # 期权多空：Put/Call 成交量比
│   ├── full_analysis.py   # 单只综合：拼技术+消息+财报+期权，调 LLM 出 10 项
│   ├── report_deep.py      # 深度模式：综合 + 五类深度 + 与上次对比 + 评分微调
│   ├── analysis_deep.py    # 五类深度分析的封装（供 report_deep / chains 用）
│   └── prompts.py          # 深度分析用的 Prompt 模板
├── chains/                 # LangChain 链与记忆（深度分析时用）
│   ├── chains.py           # 基本面深度、护城河、同行对比、空头、叙事等链
│   ├── llm_factory.py      # 创建 LangChain 用的 LLM 实例
│   ├── memory_store.py     # 历史分析结果持久化（JSONL），按 ticker+type 检索
│   └── data_fetchers.py    # 链里用的数据拉取
├── report/
│   └── build_html.py       # 把「卡片列表」变成 HTML 报告（含总览、筛选、排序）
├── data/
│   └── memory/             # memory_store 的 JSONL 文件默认放这里
│       └── memory_store.jsonl
└── docs/                   # 文档（含本博客）
```

**记住几条线即可：**

- **HTTP 入口**：`server.py`  
- **单只综合逻辑**：`agents/full_analysis.py`（技术+消息+财报+期权 → LLM → 10 项）  
- **报告长什么样**：`report/build_html.py`（卡片 → HTML）  
- **选股与代码规范**：`config/tickers.py`  
- **深度分析与记忆**：`agents/report_deep.py` + `chains/` + `memory_store`

---

## 二、技术栈一览

| 类别 | 技术 | 用途 |
|------|------|------|
| 数据 | yfinance | 行情、新闻、财报、期权、基本信息 |
| LLM | Ollama（默认）/ DeepSeek / OpenAI | 综合评分、新闻摘要、财报解读、报告总览、深度分析 |
| 服务 | FastAPI + uvicorn | HTTP API、/report 返回 HTML |
| 报告 | HTML + 内联 CSS/JS | 单页报告、筛选、排序、报告总览 |
| 深度/记忆 | LangChain（可选）+ JSONL | 五类深度链、历史分析存储与「与上次对比」 |

---

## 三、一次 Report 的大致流程（通俗版）

假设用户访问：`GET /report?market=us&limit=5`（美股前 5 只）。

1. **决定分析哪几只**  
   `server.py` 根据 `market`、`pool`、`limit`（或直接传的 `tickers`）调用 `config/tickers.get_report_tickers()`，得到股票代码列表；若有 A 股 6 位/港股 4 位，会用 `normalize_ticker()` 补全后缀。

2. **逐只跑「单只分析」**  
   对每只股票：
   - **普通模式**：`agents/full_analysis.run_full_analysis(ticker, interval, include_prepost)`  
   - **深度模式**：`agents/report_deep.run_one_ticker_deep_report(ticker)`（内部会先跑 full_analysis，再跑五类深度 + 与上次对比 + 评分微调）

3. **单只分析里具体做了什么（full_analysis）**  
   - 拉 **技术面**：`agents/technical.get_technical_summary()` → 均线、MACD、KDJ、入场/离场参考  
   - 拉 **消息面**：`agents/news.get_news_summary()`，有新闻时再 `get_news_summary_llm()` 得到 1～2 句摘要  
   - 拉 **财报与估值**：`agents/fundamental.get_fundamental_data()`，再 `get_financials_interpretation()` 得到财报解读  
   - 拉 **期权**：`agents/options.get_put_call_summary()`  
   - 把上面几块拼成一段 **Prompt**，调用 `llm.ask_llm()`，从回复里 **解析 10 项**（核心结论、趋势、MACD、KDJ、分析原因、评分、评分理由、交易动作、加仓价、减仓价）  
   - 返回一张「卡片」dict（含解析结果 + 技术/财报等原始字段），供报告用

4. **所有卡片汇总后**  
   - 再调用一次 LLM：用各只的「核心结论 + 评分 + 交易动作」生成 **报告总览**（3～5 句话 + 优先关注 1～3 只）  
   - 把「卡片列表 + 报告总览」交给 `report/build_html.build_report_html()`，生成带「报告总览」、筛选、排序的 HTML  
   - 可选：把 HTML 自动保存到 `report/output/report-MMDD-HHMM.html`

5. **深度模式多出来的事**  
   - 在 `chains/chains` 里跑五类分析（基本面深度、护城河、同行对比、空头视角、叙事变化）  
   - 从 `chains/memory_store` 取出该标的「上次」同类型分析，做「与上次对比」  
   - 把五段摘要截短后，再调一次 LLM 对「综合评分」做微调（+1/0/-1 或直接给最终分）  
   - 把深度结果和对比结论写入卡片，一并交给 `build_report_html`

整条链路可以概括成：**选股 → 逐只（数据 + LLM 综合 + 可选深度）→ 汇总报告总览 → 生成 HTML**。

---

## 四、数据流简图（文字版）

```
用户请求 /report?market=us&limit=5
        ↓
  get_report_tickers() → [AAPL, MSFT, ...]
        ↓
  for ticker in list:
      技术面(technical) ──┐
      消息面(news) + 新闻摘要 LLM ──┤
      财报(fundamental) + 财报解读 LLM ──┼→ 拼 Prompt → ask_llm() → 解析 10 项 → 卡片
      期权(options) ──┘
      （深度模式：再跑五类深度 + 记忆对比 + 评分微调 → 卡片）
        ↓
  cards 汇总 → 报告总览 LLM → build_report_html(cards, report_summary) → HTML
        ↓
  返回 HTML / 保存到 report/output/
```

---

## 五、下一篇预告

下一篇讲 **第一步：数据从哪来**——选股池怎么配置、美股/A股/港股代码如何规范化、以及 yfinance 在本项目里负责拉哪些数据，为后面「技术面、消息面、财报、期权」各篇打基础。
