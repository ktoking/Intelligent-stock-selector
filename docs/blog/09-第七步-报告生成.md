# 09 - 第七步：报告生成

前面每只股票已经得到一张「卡片」（核心结论、评分、评分理由、交易动作、加仓/减仓价、技术面/消息面/财报等字段）；第七步负责把**多张卡片**汇总成一份 HTML 报告，并加上「报告总览」、筛选、排序和自动保存。本篇讲报告结构、总览怎么来、以及筛选/排序如何实现。

---

## 一、报告生成在整体里的位置

- **输入**：卡片列表 `cards`（每项即 `run_full_analysis` 或 `run_one_ticker_deep_report` 返回的 dict）、报告标题 `title`、生成时间 `gen_time`，以及可选的 **报告总览** 文本 `report_summary`。  
- **输出**：一整份 HTML 字符串，内联 CSS/JS，单页即可用浏览器打开；可选地写入 `report/output/report-MMDD-HHMM.html`。  
- **流程**：  
  1. 若有 `report_summary`，在标题下方渲染「报告总览」区块。  
  2. 根据卡片内容收集「评分、交易动作、市场」等筛选选项，生成筛选 UI。  
  3. 为每张卡片生成 HTML 块（含评分、评分理由、核心结论、交易动作、所属板块、价格、涨跌幅、深度块等）。  
  4. 内联筛选与排序的 JS，以及「总计 / 显示数」等统计。  
  5. 返回完整 HTML；保存到文件由 `server.py` 在调用 `build_report_html` 之后完成。  

---

## 二、报告总览从哪里来

- **时机**：所有卡片跑完后、调用 `build_report_html` **之前**，在 `server.py` 里完成。  
- **做法**：  
  - 用每只的「名称(ticker)、评分、交易动作、核心结论」拼成一段短文本（每行一只）。  
  - 调用 `llm.ask_llm`，Prompt 大意是：「以下是本期报告各标的的核心结论、评分、交易动作（每行一只）。请用 3～5 句话概括本期要点，并指出优先关注的 1～3 只标的及简要理由。直接输出总览正文，不要标题或列表编号。」  
  - 把返回的文本当作 `report_summary` 传给 `build_report_html(cards, title=..., gen_time=..., report_summary=...)`。  
- **展示**：在 HTML 里，标题和生成时间下面有一个「报告总览」区块，用 `report_summary` 的内容（换行转成 `<br>`）渲染；若未生成或失败，该区块不显示。  

这样读者先看到「本期要点 + 优先关注哪几只」，再按需筛选、排序看单只卡片。

---

## 三、报告结构（HTML）

- **顶部**：报告标题、生成时间。  
- **报告总览**（若有）：一段总览文字。  
- **筛选与排序**：  
  - 排序：评分(高到低/低到高)、名称(A-Z/Z-A)、当前股价(高到低/低到高) 等。  
  - 筛选：按评分、交易动作（买入/观察/离场）、市场（美股/A股/港股）多选；深度报告还可按「大方向是否不变」筛选。  
- **卡片区**：每张卡片包含：  
  - 标题区：名称、代码、评分徽章、**评分理由**（若解析到且非「—」）。  
  - 核心结论区块。  
  - 信息区：交易动作、所属板块、当前价格、涨跌幅、市值、PE、日线多头排列、近日多空期权、市场、加仓/减仓价、技术面入场/离场参考、数据截至日、52周、量比、股息率、机构倾向、下次财报日、K线周期、是否含盘前盘后等。  
  - 若为深度报告：还有「基本面深度、护城河、同行对比、空头视角、叙事变化、与上次对比、近期对比趋势」等区块。  
- **底部**：免责声明；无匹配结果时显示「没有找到匹配的结果」。  

筛选与排序由前端 JS 根据 `data-score`、`data-action`、`data-market` 等属性完成，无需请求后端。

---

## 四、评分理由与定性解读

- **评分理由**：若卡片里有 `score_reason` 且非空非「—」，在评分徽章下方用较小字号展示，便于理解「为什么给这个分」。  
- **定性解读**：根据分数区间映射成一句中文，例如 9～10→「强烈看好」、7～8→「偏多」、5～6→「可配置」、3～4→「关注」、1～2→「观望」，在 `report/build_html._score_interpretation` 中实现。  

---

## 五、自动保存

- 在 `server.py` 里，`_run_report_impl` 得到 `html_content` 后，会按当前时间生成文件名 `report-MMDD-HHMM.html`，写入 `report/output/` 目录（若目录不存在会创建）。  
- 这样每次生成报告都会在本地留一份，无需再点「另存为」；`report/output/` 一般在 `.gitignore` 中忽略。  

---

## 六、小结与代码位置

- **建 HTML**：`report/build_html.build_report_html(cards, title=..., gen_time=..., report_summary=...)`  
- **报告总览生成**：`server.py` 里在 `build_report_html` 前，用卡片内容拼文本 + `ask_llm`，得到 `report_summary` 再传入。  
- **评分理由与定性**：`build_html` 里读 `c.get("score_reason")`、`_score_interpretation(c.get("score"))`。  
- **自动保存**：`server.py` 中在返回 HTML 前写入 `report/output/report-MMDD-HHMM.html`。  

下一步：[10 - 第八步：深度分析与记忆](10-第八步-深度分析与记忆.md) —— 五类深度分析、与上次对比、memory_store 持久化与评分微调。
