# 08 - 第六步：LLM 综合评分

前面几步已经把「技术面、消息面、财报与估值、期权多空」都拉齐并整理成文字；第六步负责把这些内容拼成一段 Prompt，交给 LLM，并**按固定格式解析出 10 项**（核心结论、趋势、MACD、KDJ、分析原因、评分、评分理由、交易动作、加仓价、减仓价）。本篇讲拼 Prompt 的方式、10 项分别是什么、以及解析与默认值怎么处理。

---

## 一、综合评分在整体里的作用

- **输入**：技术面摘要、消息面（新闻摘要 + 标题列表）、财报与估值（含可选财报解读）、期权多空描述。  
- **过程**：把这些内容按「技术面 / 消息面 / 财报与估值」三段拼成 **User Prompt**，再配一个 **System Prompt**（「你是多维度分析师，按 10 项格式输出，每行一项」）。  
- **输出**：LLM 回复一段文本，每行一项，格式如「核心结论：…」「评分：7」「交易动作：观察」等；代码从这段文本里**解析出 10 项**，填进「卡片」dict，供报告展示和后续深度微调使用。  

也就是说：**谁在评、依据什么，都由「拼进 Prompt 的数据 + 模型」决定；项目只负责格式约束和解析，不写死公式分。**

---

## 二、Prompt 长什么样（结构）

- **System**：大意是「你是美股多维度分析师（或超短线分析师）。请严格按用户要求的 10 项格式输出，每行一项，不要遗漏。」  
- **User**：  
  - 先写清「时间维度」（日线维度 / 分K 短线维度、是否含盘前盘后）。  
  - 再列出「请输出以下 10 项，每项单独一行，格式严格如下」以及 10 项的名称与说明。  
  - 然后三大段：【技术面】…【消息面】…【财报/估值/期权】…  

10 项的名称与说明在代码里是固定的，例如（大意）：  
1. 核心结论：一句话总结该标的当前是否值得关注及主要理由  
2. 趋势结构：一句话描述均线趋势/多头排列等  
3. MACD 状态：一句话描述位置与金叉死叉  
4. KDJ 状态：一句话描述超买超卖与钝化  
5. 分析原因：2～4 句综合结论，可结合 PE、期权、均线  
6. 评分：10～1 的数字，仅数字，10=最强 1=最弱  
7. 评分理由：一句话说明为何给该评分  
8. 交易动作：仅填其一「买入 / 观察 / 离场」  
9. 加仓价格：尽量根据技术面入场参考给具体数字，无法则填「—」  
10. 减仓价格：尽量根据离场参考给具体数字，无法则填「—」  

具体字句以 `agents/full_analysis._build_prompt` 为准；日 K 与分 K 的「角色」和「时间范围」描述会略有不同（波段 vs 超短线）。

---

## 三、解析与默认值（_parse_llm_output）

- 按行分割 LLM 回复，每行若以「核心结论：」「趋势结构：」「评分：」等开头，就截取冒号后的内容，写入对应的 key。  
- **评分**：从「评分：」那一行里提取数字（去掉非数字字符），然后 **限制在 [1, 10]**；若解析失败则用默认 **5**。  
- **交易动作**：从「交易动作：」那一行取文字，经 `_normalize_action` 归一为三种之一：「买入」「观察」「离场」（如「加仓」「多头」→ 买入，「离场」「减仓」→ 离场，其余 → 观察）。  
- **加仓/减仓价格**：若为「—」或空则保留为「—」，否则保留 LLM 给的数字或文字。  
- **评分理由**：从「评分理由：」那一行取内容，若没有这一行则卡片里用「—」展示。  

解析结果放进一个 dict，再和「技术面、消息面、财报、期权」等原始字段一起组成**单只卡片的完整 dict**，返回给报告流程。

---

## 四、新闻摘要与财报解读如何参与

- **新闻摘要**：若调用了 `get_news_summary_llm` 且返回非空，在「消息面」段落里会先写「新闻摘要：<1～2 句 + 偏多/中性/偏空>」，再写「近期标题：…」。这样 LLM 既有概括又有具体标题。  
- **财报解读**：若调用了 `get_financials_interpretation` 且返回非空，在「财报/估值」段落里会先写「财报解读：<2～3 句 + 1 个风险>」，再写「财报原始摘要(参考)：…」。这样综合结论更易结合「趋势与风险」的人话描述。  

两者都是「多一步 LLM 预处理，再喂给综合」，提升可解释性和阅读效率；对应实现见第三步和第四步博客。

---

## 五、小结与代码位置

- **拼 Prompt**：`agents/full_analysis._build_prompt(...)`，参数包含技术、消息、财报、期权，以及可选的 `news_llm_summary`、`financials_interpretation`。  
- **调 LLM**：`llm.ask_llm(system=..., user=prompt)`，在 `run_full_analysis` 里调用。  
- **解析**：`_parse_llm_output(raw)`，得到 10 项；`_normalize_action` 归一交易动作。  
- **返回卡片**：`run_full_analysis` 把解析结果与 technical、fundamental、options 等字段合并成一张卡片 dict。  

下一步：[09 - 第七步：报告生成](09-第七步-报告生成.md) —— HTML 报告怎么生成、筛选与排序、报告总览与自动保存。
