# 03 - 第一步：数据从哪来

报告要分析「哪几只股票」，以及股票代码在美股/A股/港股里怎么统一，都在这第一步里解决。本篇讲选股池、多市场、代码规范化，以及项目里用到的数据来源（yfinance）大致能提供什么。

---

## 一、报告里「分析谁」由什么决定

用户可以通过两种方式指定分析对象：

1. **直接传股票代码**：`/report?tickers=AAPL,MSFT,600519.SS,0700.HK`  
   - 服务会按逗号拆分，并对每个代码做「规范化」（见下）。  
2. **不传 tickers，传市场 + 选股池 + 数量**：`/report?market=us&limit=5` 或 `market=cn&pool=csi2000&limit=10`  
   - 由 `config/tickers.get_report_tickers(market, pool, limit)` 返回一个股票代码列表，例如美股大盘前 N 只、美股小盘（罗素2000 风格）、A 股小盘（中证2000 风格）等。

对应代码在 `server.py` 里：先解析 `tickers` 和 `market`/`pool`/`limit`，若没有 `tickers` 就调 `get_report_tickers(...)`，得到列表后再对每个代码做 `normalize_ticker(...)`（A 股 6 位补交易所、港股 4 位补 `.HK`）。

---

## 二、选股池与多市场（config/tickers.py）

- **市场**：`market=us` 美股、`market=cn` A股、`market=hk` 港股。  
- **选股池**：  
  - 不传或 `pool=sp500`：大盘。美股即 S&P 500 风格列表；A 股为沪深龙头列表。  
  - `pool=russell2000`：美股小盘（罗素2000 风格）。  
  - `pool=csi2000`：A 股小盘（中证2000 风格）。  

`get_report_tickers(market, pool, limit)` 会根据 `market` 和 `pool` 选择对应的静态列表（如 `US_QUALITY_TICKERS_FALLBACK`、`CN_QUALITY_TICKERS_FALLBACK`、`RUSSELL_2000_TICKERS_FALLBACK` 等），然后截取前 `limit` 只。  
这些列表在 `config/tickers.py` 里，是「静态候选池」；若以后接动态接口（如实时取指数成分股），只需改 `get_report_tickers` 的实现即可。

---

## 三、股票代码规范化（normalize_ticker）

不同市场代码格式不一样，项目里统一用 yfinance 能识别的格式：

- **美股**：一般就是字母代码，如 `AAPL`，不做改动（仅统一大小写）。  
- **A 股**：交易所后缀必须明确。  
  - 6 位数字：`60xxxx`、`68xxxx` → 上海，补 `.SS`；`00xxxx`、`30xxxx` → 深圳，补 `.SZ`。  
  - 例如：`600519` → `600519.SS`，`000858` → `000858.SZ`。  
- **港股**：4 位数字补 `.HK`，如 `0700` → `0700.HK`。  
- 若用户已经传了带 `.SS`/`.SZ`/`.HK` 的代码，则只做大小写统一，不再改后缀。

实现都在 `config/tickers.normalize_ticker()`。  
这样无论是「手动传 tickers」还是「从选股池拿列表」，进到分析流程的都是统一格式，yfinance 和后续模块都不用再区分市场写法。

---

## 四、数据来源：yfinance 能提供什么

项目里行情、新闻、财报、期权等**原始数据**都来自 **yfinance**（基于 Yahoo Finance）。它免费、接口简单，支持美股、A股、港股（部分数据在 A/港可能不如美股全）。

和本项目用到的对应关系可以简单理解为：

| 项目模块 | 用的 yfinance 能力 | 说明 |
|----------|--------------------|------|
| 技术面 | 历史 K 线 `stock.history(period=..., interval=..., prepost=...)` | 开高低收、成交量，用于算 MA、MACD、KDJ |
| 消息面 | `stock.news` | 近期新闻标题、链接、发布时间等 |
| 财报与估值 | `stock.financials`、`stock.info` | 财报表、当前价、涨跌幅、PE、市值、52 周高低、股息、机构评级等 |
| 期权 | `stock.options`、`stock.option_chain(到期日)` | 最近到期日的 Put/Call 链，取成交量算多空比 |

**注意**：A 股/港股在 yfinance 里有时没有「财报日历/下次财报日」，项目里对非美股会跳过相关接口，避免误报「可能退市」之类提示。

---

## 五、小结与对应代码

- **选股与列表**：`config/tickers.get_report_tickers(market, pool, limit)`，各种 `*_TICKERS_FALLBACK` 列表。  
- **代码规范化**：`config/tickers.normalize_ticker(t)`，在 `server.py` 解析 `tickers` 后对每个代码调用。  
- **数据来源**：技术面、消息面、财报、期权分别在 `agents/technical`、`agents/news`、`agents/fundamental`、`agents/options` 里用 yfinance 拉取；下一篇起会按「技术面 → 消息面 → 财报 → 期权」顺序讲每一步的实现。

下一步：[04 - 第二步：技术面分析](04-第二步-技术面分析.md) —— 均线、MACD、KDJ、入场/离场参考是怎么算的、怎么给 LLM 用。
