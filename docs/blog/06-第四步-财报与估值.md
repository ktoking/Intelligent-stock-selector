# 06 - 第四步：财报与估值

财报与估值模块负责拉取「财报摘要、当前价、涨跌幅、PE、市值、52 周高低、股息、机构评级」等，并可选地用 LLM 对财报做 2～3 句解读，再一起喂给综合评分。本篇讲这些数据从哪来、盘前盘后怎么处理、以及财报解读如何接入。

---

## 一、财报与估值在整体里的作用

- **输入**：一只股票代码，以及是否使用「盘前/盘后」价格（日 K 且勾选盘前盘后时为 True）。  
- **输出**：一个字典，包含公司名、行业、板块、市值、当前价、涨跌幅、PE、财报摘要字符串、52 周高低、量比、股息率、机构倾向、下次财报日等。  
- **用途**：  
  - 直接填进报告卡片的「当前价格、涨跌幅、市值、市盈率、52周、量比、股息、机构倾向、下次财报日」等。  
  - 和「财报解读」（若有）一起拼进综合 Prompt，让 LLM 写分析原因、评分理由时既有数字又有定性解读。  

---

## 二、数据从哪里拉（yfinance）

- **财报表**：`stock.financials`，转成字符串 `financials_str`（若为空则写「无」）。  
- **行情与基本信息**：`stock.info`，例如：  
  - 当前价、涨跌幅：优先用 `regularMarketPrice`、`regularMarketChangePercent`；  
  - 若开启「盘前盘后」：先用 `postMarketPrice`/`postMarketChangePercent`，没有再试 `preMarket*`，再没有则用最近 5 日 K 线或 info 里的价格推算涨跌幅。  
- **52 周高低、量比、股息率、机构评级、下次财报日**：都从 `info` 或 `stock.history` 里取；A 股/港股不调 `get_earnings_dates`，避免误报「可能退市」类提示。  

实现入口：`agents/fundamental.get_fundamental_data(ticker, use_prepost=False)`。  
`use_prepost` 由 `full_analysis` 根据「是否为日 K 且勾选盘前盘后」传入。

---

## 三、财报解读 LLM（get_financials_interpretation）

- **输入**：ticker + 上面得到的 `financials_str`（可截前 1200 字避免 token 过多）。  
- **做法**：调用 `llm.ask_llm`，Prompt 大意是：「请用 2～3 句话概括收入与利润趋势、现金流情况，并指出 1 个主要风险或关注点；直接输出解读不要标题。」  
- **输出**：一段纯文本；若财报为空或调用失败，返回空字符串。  

在 `full_analysis` 里：拿到 `get_fundamental_data` 的结果后，再调 `get_financials_interpretation(ticker, fundamental.get("financials_str") or "")`，把解读和原始财报摘要一起交给 `_build_prompt`。

实现位置：`agents/fundamental.get_financials_interpretation(ticker, financials_str, max_chars=1200)`。

---

## 四、在综合 Prompt 里长什么样

财报/估值段落在 Prompt 里大致是：  
- 公司名、行业、板块、市值、当前价、涨跌幅、PE、近日多空期权（见下一篇）。  
- 若有财报解读：先写「财报解读：<LLM 的 2～3 句 + 1 个风险>」，再写「财报原始摘要(参考)：<前 600 字>…」。  
- 若无解读：只写「财报原始摘要(参考)：…」。  

这样 LLM 既有「人话版」趋势与风险，又能按需查原始数字。

---

## 五、小结与代码位置

- **拉财报与估值**：`agents/fundamental.get_fundamental_data(ticker, use_prepost=...)`  
- **财报解读**：`agents/fundamental.get_financials_interpretation(ticker, financials_str)`  
- **拼进 Prompt**：`agents/full_analysis._build_prompt` 里的 `fund_intro`、`fund_raw`，以及 `fund_text` 的组成。  

下一步：[07 - 第五步：期权多空](07-第五步-期权多空.md) —— Put/Call 成交量、多空比与偏多/偏空/中性描述。
