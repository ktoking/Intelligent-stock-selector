# 10 - 第八步：深度分析与记忆

普通报告只做「技术+消息+财报+期权 → LLM 综合 → 10 项」；**深度模式**会在此基础上再跑「五类深度分析」、做「与上次对比」，并对综合评分做一次 **LLM 微调**，结果会写入持久化「记忆」供下次对比。本篇讲五类分析是什么、与上次对比怎么实现、以及记忆存在哪里、怎么用。

---

## 一、深度模式在整体里的位置

- **触发**：请求 Report 时传 `deep=1`，例如 `/report?deep=1&limit=5`。  
- **流程**：对每只股票不再只调 `run_full_analysis`，而是调 `run_one_ticker_deep_report(ticker)`，其内部会：  
  1. 先跑一次 `run_full_analysis`，得到「综合评分 + 10 项」的卡片基础。  
  2. 再跑 **五类深度分析**（基本面深度、护城河、同行对比、空头视角、叙事变化），每类由 LangChain 链 + LLM 完成。  
  3. 从 **memory_store** 取出该标的「上次」同类型分析（若有），做 **与上次对比**（大方向是否一致、近期趋势等）。  
  4. 用五段深度摘要的**短文**（每段截前约 200 字）再调一次 LLM，对当前综合评分做 **微调**（输出「最终评分：N」或「调整：+1/0/-1」），更新卡片上的 `score`。  
  5. 把五类摘要、对比结论、微调后的评分等写回卡片；同时把本次深度结果 **写入 memory_store**，供下次「与上次对比」用。  

若未安装 LangChain 或链执行失败，深度块会显示「深度摘要未生成」或错误信息，但综合评分和普通卡片仍会保留。

---

## 二、五类深度分析分别是什么

1. **基本面深度**：收入与增长质量、盈利能力、现金流、商业模式、中长期风险等；基于财报与公司信息，由链里的 LLM 按模板输出。  
2. **护城河**：技术/切换成本/网络效应/规模/品牌等壁垒；Prompt 在 `agents/prompts` 或 `chains/chains` 中。  
3. **同行对比**：与若干同行在增速、盈利、估值等方面的差异；需要指定 peers（或默认一批），由链拉数据 + LLM 对比。  
4. **空头视角**：增长可持续性、替代风险、估值风险、下跌触发点等；Prompt 引导模型从「看空」角度写。  
5. **叙事变化**：财报与话术变化、市场叙事是否改变；基于近期信息由 LLM 概括。  

每类分析的结果会存进 **memory_store**（按 `ticker` + `analysis_type`），并截取一段写入报告卡片的「深度」区块；同时取每段前约 200 字拼成短文，用于**评分微调**的那次 LLM 调用。

---

## 三、与上次对比怎么实现

- **数据来源**：`chains/memory_store`。每次深度分析完成后，会把当次结果 **append** 到 `data/memory/memory_store.jsonl`（或环境变量 `STOCK_AGENT_MEMORY_DIR` 指定目录）。  
- **检索**：按 `ticker` + `analysis_type`（如 `fundamental_deep`、`moat`、`peers` 等）从 JSONL 里读**最近 N 条**（如 2 条），按时间倒序。  
- **对比**：把「上次」同类型分析的文本（或摘要）拼进 Prompt，让 LLM 回答「大方向是否一致、近期趋势如何」等，输出写入卡片的「与上次对比（大方向）」「近期对比趋势」等字段。  
- **首次或无历史**：若没有该标的该类型的往期记录，对比区块会显示「首次运行或尚无历史记录，再次运行 deep=1 后将显示与上次对比」之类提示。  

也就是说：**记忆是按「标的 + 分析类型」存的，不是按「用户会话」；对比是「同一只股票、同一类分析、上次 vs 这次」。**

---

## 四、评分微调（_adjust_score_by_deep）

- **输入**：当前综合评分（1～10）、五类深度分析的摘要（每段截前约 200 字）。  
- **Prompt**：大意是「根据下面五段深度摘要，对当前评分做微调；只输出一行：要么『最终评分：N』（N 为 1～10 整数），要么『调整：+1 或 0 或 -1』」。  
- **解析**：若匹配到「最终评分：N」，则最终分 = clamp(N, 1, 10)；若匹配到「调整：±1」，则最终分 = 原分 + 调整量再 clamp。  
- **失败**：若 LLM 未返回有效格式或调用异常，则保留原综合评分，不强制改分。  

实现位置：`agents/report_deep._adjust_score_by_deep`；调用方在 `run_one_ticker_deep_report` 里，在五类深度和对比都跑完后执行。

---

## 五、memory_store 存什么、怎么用

- **存什么**：每行一条 JSON，包含 `ticker`、`analysis_type`、`content`（分析结果全文或序列化后的字符串）、`ts`（时间戳）。  
- **写入**：由 LangChain 链在完成某类分析后调用 `memory_store.save(ticker, analysis_type, content)`，追加到 JSONL 文件。  
- **读取**：`memory_store.retrieve(ticker, analysis_type=None, last_n=2)`，按 ticker（和可选 analysis_type）取最近 last_n 条，用于「与上次对比」和上下文摘要。  
- **存储目录**：默认 `data/memory/`；可通过环境变量 `STOCK_AGENT_MEMORY_DIR` 指定其它目录。  

项目**没有**用向量库或语义检索，记忆是「按 key（ticker + type）取最近几条」，不是「按相似问题检索」；若要做 RAG，可参考 `docs/RAG文档建立与数据来源.md`，把历史摘要等再做 embedding 存向量库。

---

## 六、小结与代码位置

- **深度入口**：`agents/report_deep.run_one_ticker_deep_report(ticker)`  
- **五类链**：`chains/chains`（如 `chain_fundamental_deep`、`chain_moat`、`chain_peers`、`chain_short`、`chain_narrative` 等），可由 `chain_full_deep` 或类似组合一次跑完；深度分析可配置为并行（`DEEP_PARALLEL=1`）以缩短耗时。  
- **与上次对比**：`chains` 里调用 `memory_store.retrieve` 拿到上次结果，再调 `run_comparison` 或等价逻辑生成对比文本。  
- **评分微调**：`agents/report_deep._adjust_score_by_deep`  
- **记忆读写**：`chains/memory_store.save`、`retrieve`  

下一步：[11 - 配置与扩展](11-配置与扩展.md) —— 环境变量、模型切换、RAG/OpenClaw 等扩展思路。
