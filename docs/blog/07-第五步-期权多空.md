# 07 - 第五步：期权多空

期权多空模块用「最近到期日的 Put/Call 成交量」算一个多空比，并给出「偏多 / 中性 / 偏空」的简短描述，供报告展示和综合 Prompt 使用。本篇说明数据从哪来、比例怎么算、以及如何参与综合评分。

---

## 一、期权多空在整体里的作用

- **输入**：一只股票代码（通常美股才有期权数据，A 股/港股多数没有）。  
- **输出**：多空比（put 成交量 / call 成交量）、以及一句描述：「偏多（call 活跃）」「偏空（put 活跃）」或「中性」。  
- **用途**：  
  - 在报告卡片的「近日多空期权」里展示。  
  - 拼进综合 Prompt 的「财报/估值/期权」段落，让 LLM 在写分析原因、评分理由时考虑期权情绪。  

没有期权数据时（例如 A 股、或该标的无期权），返回 `ok: False`，描述为「无期权数据」，Prompt 里会照常写上，LLM 会当「无此项信息」处理。

---

## 二、数据从哪里拉（yfinance）

- 用 `yf.Ticker(ticker)` 取 `stock.options`（到期日列表）。  
- 若没有到期日，直接返回「无期权数据」。  
- 取**最近一个到期日**，用 `stock.option_chain(到期日)` 拿到当月的 call 和 put 链。  
- 从 **calls** 和 **puts** 的表格里分别对 **volume** 列求和，得到 `call_vol` 和 `put_vol`。  

实现位置：`agents/options.get_put_call_summary(ticker)`。

---

## 三、多空比与描述怎么定

- **多空比**：`ratio = put_vol / call_vol`（若 call_vol 为 0 则按约定给 0 或 2，避免除零）。  
- **描述**：  
  - ratio < 0.7：call 成交量明显大于 put → 「偏多（call 活跃）」  
  - ratio > 1.3：put 成交量明显大于 call → 「偏空（put 活跃）」  
  - 其余：「中性」  

这些阈值可在 `agents/options` 里按需调整；当前项目没有再做更细的期限结构或 IV，只做「最近到期日成交量」的简单多空信号。

---

## 四、在综合 Prompt 里长什么样

在 `full_analysis._build_prompt` 里，期权和财报、估值放在同一大段，例如：  
「近日多空期权：<description> (put/call=<ratio>)」  
若没有期权数据，description 就是「无期权数据」，ratio 为空，LLM 会知道这项缺失。

---

## 五、小结与代码位置

- **拉期权与算多空比**：`agents/options.get_put_call_summary(ticker)`  
- **调用方**：`agents/full_analysis.run_full_analysis` 里拉完技术、消息、财报后，再拉期权，然后把 `description` 和 `ratio` 拼进 `_build_prompt`。  

下一步：[08 - 第六步：LLM 综合评分](08-第六步-LLM综合评分.md) —— 如何把技术+消息+财报+期权拼成 Prompt、模型输出哪 10 项、以及怎么解析。
