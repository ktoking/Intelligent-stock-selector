# 小白说明：拉 Report 用了哪些分析？LangChain 在哪儿用？

## 一、你「拉了 report」之后，用到了哪些分析？

你访问 **`/report`**（或 `/report?limit=10`）时，对**每一只股票**都会做下面这些事（可以理解成「一套分析」）：

### 1. 先拉「外部数据」（4 块）

| 分析维度 | 做什么 | 代码在哪 |
|----------|--------|----------|
| **技术面** | 用日 K 线算：均线 MA5/10/20/60、MACD、KDJ、是否「日线多头排列」 | `agents/technical.py` |
| **消息面** | 拉这只股票最近的新闻标题、时间 | `agents/news.py` |
| **财报/基本面** | 拉市值、行业、当前价、涨跌幅、市盈率 PE、财报摘要等 | `agents/fundamental.py` |
| **近日多空期权** | 拉最近到期的 put/call 成交量，算多空比（偏多/偏空/中性） | `agents/options.py` |

### 2. 再交给「大模型」综合写一段话

把这 4 块数据拼成一段**提示词**，调用**一次**大模型（Ollama/DeepSeek 等），让模型根据这些数据写出：

- 趋势结构（日 K）
- MACD 状态
- KDJ 状态
- 分析原因
- 评分（1～5）
- 交易动作（多头/观望等）
- 加仓/减仓价格建议

### 3. 最后生成你看到的 HTML 报告

每只股票得到上面这一张「卡片」数据，所有卡片拼成一份带筛选、排序的 HTML 报告，就是你在浏览器里看到的 **Report 页面**。

**小结：拉 report = 对每只股票做「技术面 + 消息面 + 财报 + 期权」4 类数据拉取 + 1 次大模型综合分析，再生成整份 HTML。**

---

## 二、LangChain 在这次「拉 report」里有用吗？

**没有。**  
你这次调用 **`/report`** 时，**不会**经过 LangChain，也不会用到 LangChain 的「链」或「长期上下文」。

- Report 的流程是：**`server.py`** → **`run_full_analysis(每只股票)`** → 用 **`llm.ask_llm`** 直接调大模型（Ollama/DeepSeek 等）。
- 也就是说：**拉 report = 用「4 类数据 + 1 次 LLM」**，没有用 LangChain。

---

## 三、那 LangChain 在项目里到底用在哪？

LangChain 用在**另一类**功能上：**「深度分析」**（单只股票、多步骤、可存历史）。

也就是这些接口：

- `/analyze/deep`（基本面深度）
- `/analyze/moat`（护城河）
- `/analyze/peers`（同行对比）
- `/analyze/short`（空头视角）
- `/analyze/narrative`（叙事变化）
- `/analyze/thesis`（投资假设拆解）
- `/analyze/full`（上面多步组合）

在这些接口里，LangChain 负责：

1. **多步骤编排**：按顺序跑「拉数据 → 填提示词 → 调 LLM」，每一步算一条「链」。
2. **长期上下文**：每次分析结果可以存起来（memory），后面用 `/memory`、`/memory/context` 可以查「上次分析」，做对比。

所以可以简单记：

- **拉 report**：不用 LangChain，用的是「4 类分析 + 1 次 LLM」。
- **用 LangChain 的**：是「深度分析」那几条接口（多步骤 + 可存历史）。

---

## 四、一张图总结

```
你访问 /report
    ↓
对每只股票：
  ① 技术面（MA、MACD、KDJ、日线多头排列）
  ② 消息面（新闻）
  ③ 财报（市值、PE、财报摘要等）
  ④ 期权（近日多空）
    ↓
  ⑤ 把这 4 块拼成一段话，交给大模型写：趋势/MACD/KDJ/分析原因/评分/交易动作/加仓减仓
    ↓
所有股票的结果 → 生成一份 HTML 报告（你看到的页面）

❌ 这里没有用 LangChain

---

你访问 /analyze/deep 或 /analyze/full 等
    ↓
用 LangChain 编排：拉数据 → 填提示词 → 调 LLM
    ↓
结果可以存进「长期上下文」，以后用 /memory 查
✅ 这里才用 LangChain
```

如果你愿意，下一步可以再说：**「深度分析」里具体每一步在算啥**（还是用同样的小白话）。
